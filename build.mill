// import Mill dependency
import mill._
import mill.define.Sources
import mill.modules.Util
import mill.scalalib.TestModule.ScalaTest
import scalalib._
// support BSP
import mill.bsp._

// Note: This project requires .mill-jvm-opts file containing:
//   -Dchisel.project.root=${PWD}
// This is needed because Chisel needs to know the project root directory
// to properly generate and handle test directories and output files.
// See: https://github.com/com-lihaoyi/mill/issues/3840
// build.mill是mill项目中的构建定义文件. 它本质是个.scala文件. 它被要求放在./mill同级目录.

//"Mill 把“构建脚本就是代码”这一思路做得比 sbt 更整洁轻量。"


// 运行 .mill ./mill chisel_template.test 时, mill会:
// 1. 根据约定查找源代码(在./src下).
// 2. 处理依赖关系. 此处需要chisel库.
// 3. 编译 所有 源代码.
// 


//定义一个名叫 `chisel_template` 的顶级 Mill 模块（singleton），它继承自 `SbtModule`，并且用 `m` 作为该模块在内部的自引用名字（self-alias）
// object是单例对象。 也就是等同于class后new一个实例. object定义时自动成为一个实例, 而且不能再new了.
// => 运算符有两种含义:
// 1.     [自变量x]=>[代码块]   这样一个表达式, 其值是一个 x的匿名函数. 例如: val myfun_x = {x => x + 1}   
// 2.     class/object后立即跟随的: object myclass { m => ... }  这样一个表达式, 是允许在开头定义一个实例(对象)的self-alias. 注意alias是对象, 不是类. 

// this关键字: 指向“正在调用这个方法的那个 实例 ”。 可以在class的声明中使用, 它将表示在未来将要被创建的实例.
//        此处m=myclass.this. 方便在类/对象内部引用自己.
// override 重写父类的方法.
object `chisel_template` extends SbtModule { m =>
  override def millSourcePath = super.millSourcePath / os.up
  override def scalaVersion = "2.13.16"
  //Seq()是Scala的序列结构大类. 其中, list(链表结构), vector(向量结构)...都是其子类. 如果声明一个Seq, 编译器会根据内容自动选择具体的子类. 默认是List. 接下来你可以用.toVector方法把一个Seq实例从List转换为Vector.比如:
    // val myseq: Seq[Int] = Seq(1,2,3)  // 默认是List. 这一句等价于 val myseq: List[Int] = List(1,2,3)
    // val myvec: Vector[Int] = myseq.toVector  //得到一个和myseq内容一样的Vector.
  override def scalacOptions = Seq(
    "-language:reflectiveCalls",
    "-deprecation",
    "-feature",
    "-Xcheckinit",
    "-Ymacro-annotations",
  )
  override def ivyDeps = Agg(
    ivy"org.chipsalliance::chisel:7.0.0-RC1",
  )
  override def scalacPluginIvyDeps = Agg(
    ivy"org.chipsalliance:::chisel-plugin:7.0.0-RC1",
  )
  object test extends SbtTests with TestModule.ScalaTest {
    override def ivyDeps = m.ivyDeps() ++ Agg(
      ivy"org.scalatest::scalatest::3.2.19"
    )
  }
}
